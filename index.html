<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin ‚Ä¢ ProPricing</title>
<link rel="icon" type="image/png" href="ProPlugin LOGO.png">

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: { sans: ['Kanit','Prompt','system-ui','sans-serif'] },
        colors: { brand: { dark:'#0b0b0c', red:'#E11D2E' } },
        boxShadow: { soft: '0 6px 18px rgba(0,0,0,.25)' }
      }
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>

<style>
  :root { color-scheme: dark; }
  html,body{ height:100%; background:#0b0b0c }
  ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
  .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }
  @media print { .no-print{display:none!important} .print-only{display:block} }

  .filter-btn{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;margin-left:6px;border-radius:4px;background:#333;border:1px solid #555;transition:.2s;vertical-align:middle}
  .filter-btn:hover{background:#444}.filter-btn.active{background:#E11D2E;border-color:#ff5566}
  .filter-dropdown{display:none;position:absolute;z-index:100;background:#18181b;border:1px solid #555;border-radius:8px;padding:8px;margin-top:4px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.5);min-width:200px}
  .filter-dropdown-content{display:flex;flex-direction:column;gap:4px}
  .resizer{position:absolute;top:0;right:0;width:5px;cursor:col-resize;user-select:none;height:100%}
  .resizer:hover,.resizing{background-color:#E11D2E}
  table{table-layout:fixed;border-collapse:collapse}
  table th,table td{border:1px solid #3f3f46}
  #productTHead{z-index:20} #productBody{position:relative;z-index:1}
  .style-btn{width:28px;height:28px;border-radius:6px;border:1px solid #555;background:#333;display:grid;place-items:center}
  .style-btn.active{background:#E11D2E;border-color:#ff5566}

  #toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
  .toast{padding:12px 20px;border-radius:8px;color:white;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.5);border:1px solid #555;animation:toast-in .3s ease,toast-out .3s ease 2.7s}
  .toast.info{background:#18181b}.toast.success{background:#166534;border-color:#22c55e}.toast.error{background:#991b1b;border-color:#ef4444}
  @keyframes toast-in{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes toast-out{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

  .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:9990;display:grid;place-items:center}
  .confirm-modal{background:#18181b;border:1px solid #555;border-radius:16px;padding:24px;width:100%;max-width:400px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
</style>
</head>

<body class="text-white font-sans">

<!-- ============ SETUP / LOGIN / CLOUD ============ -->
<section id="setupView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">First-Time Setup</div>
    </div>
    <div class="text-zinc-400 mb-4">Please create the primary 'host' account to begin.</div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="setupUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" value="host" disabled />
    <label class="text-sm text-zinc-400 mt-4 block">Choose a strong password</label>
    <input id="setupPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="password" />
    <label class="text-sm text-zinc-400 mt-4 block">Confirm password</label>
    <input id="setupPassConfirm" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="confirm password" />
    <button id="btnCreateHost" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create Host Account</button>
  </div>
</section>

<section id="loginView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">ProPlugin ‚Ä¢ ProPricing</div>
    </div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="loginUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="username" />
    <label class="text-sm text-zinc-400 mt-4 block">Password</label>
    <input id="loginPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="password" />
    <button id="btnLogin" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Sign in</button>
  </div>
</section>

<section id="cloudSetupView" class="min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
       <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">Cloud Setup</div>
    </div>
    <p class="text-zinc-400 mb-4">Please set up GitHub Gist for cloud storage. You can create a new Gist or load from an existing one.</p>
    <label class="text-sm text-zinc-400">GitHub Personal Access Token (scope: gist)</label>
    <input id="cloudToken" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="ghp_..." />
    <label class="text-sm text-zinc-400 mt-4 block">Gist ID (optional for new Gist)</label>
    <input id="cloudGistId" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="e.g. a1b2c3d4..." />
    <div class="flex flex-col gap-4 mt-6">
      <button id="btnCloudCreate" class="w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create New Gist</button>
      <button id="btnCloudLoad" class="w-full py-3 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold">Load from Existing Gist</button>
    </div>
  </div>
</section>

<!-- ============ APP ============ -->
<section id="appView" class="hidden min-h-screen">
  <header class="sticky top-0 z-40 bg-brand.dark/95 backdrop-blur border-b border-zinc-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div id="logoBox" class="w-10 h-10 rounded-xl bg-zinc-100 grid place-items-center overflow-hidden select-none">
          <img id="appHeaderLogo" src="ProPlugin LOGO.png" class="w-full h-full object-contain" alt="logo">
        </div>
        <div class="text-xl sm:text-2xl font-semibold tracking-wide">ProPricing</div>
        <span id="roleBadge" class="ml-2 text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700"></span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnSettings" class="hidden px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">‚öôÔ∏è</button>
        <button id="btnLogout" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">Sign out</button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 pb-4 flex flex-col lg:flex-row gap-3">
      <div class="relative flex-1">
        <input id="searchInput" class="w-full text-xl sm:text-2xl px-5 py-4 rounded-2xl border border-zinc-700 bg-white text-black focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="Search (SKU / Product Name)..." />
        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500">üîé</div>
      </div>
      <select id="channelSelect" class="px-4 py-3 rounded-2xl bg-[#FF0000] border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red"></select>
      <div class="px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 flex items-center gap-2">
        <span class="text-sm text-zinc-400">Select Expire Date</span>
        <input id="dateRangePicker" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 w-64 text-center">
        <input id="dateStart" type="date" class="hidden">
        <input id="dateEnd" type="date" class="hidden">
      </div>
      <button id="btnNewProduct" class="px-5 py-3 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 font-semibold">Add Item</button>
      <button id="btnPrintModal" class="px-5 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Print</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="overflow-auto border border-zinc-800 rounded-2xl">
      <table class="w-full text-sm">
        <thead id="productTHead" class="bg-zinc-900/70 border-b-2 border-zinc-700 sticky top-0"></thead>
        <tbody id="productBody" class="[&>tr:nth-child(odd)]:bg-zinc-800/60"></tbody>
      </table>
    </div>
    <div id="pagination" class="mt-4 flex justify-center items-center gap-1"></div>
  </main>
</section>

<!-- ============ SETTINGS PANEL ============ -->
<div id="settingsPanel" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm">
  <div class="absolute inset-4 bg-zinc-950/95 border border-zinc-800 rounded-2xl overflow-hidden grid grid-cols-[260px_1fr]">
    <aside class="bg-zinc-900/60 border-r border-zinc-800 p-3 space-y-2">
      <div class="text-sm text-zinc-400 px-2">Settings</div>
      <button data-tab="data" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Master Data</button>
      <button data-tab="promo" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Promotion</button>
      <button data-tab="templates" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Template Management</button>
      <button data-tab="logo" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Logo</button>
      <button data-tab="dealer" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Dealer Settings</button>
      <button data-tab="users" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">User Management</button>
      <button data-tab="cloud" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Cloud Sync</button>
      <button data-tab="history" class="set-tab w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Usage History</button>
      <div class="absolute bottom-3 left-3 right-3">
        <button id="btnCloseSettings" class="w-full text-sm px-2 py-1.5 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Close</button>
      </div>
    </aside>
    <section id="settingsContent" class="p-6 overflow-auto"></section>
  </div>
</div>

<!-- ============ EDITOR MODAL ============ -->
<div id="editorModal" class="hidden fixed inset-0 z-[70] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
      <div id="editorTitle" class="text-xl font-semibold">Edit Product</div>
      <button id="btnCloseEditor" class="px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-auto h-[calc(100%-100px)]">
      <div class="space-y-4">
        <div><label class="text-sm text-zinc-400">SKU</label><input id="edSku" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Description</label><input id="edDesc" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Details</label><textarea id="edDetails" rows="4" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></textarea></div>
        <div><label class="text-sm text-zinc-400">Brand</label><input id="edBrand" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Category</label><input id="edCategory" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
      </div>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-zinc-400">Normal Price</label><input id="edNormal" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Promotion Price</label><input id="edPromo" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Expires Date</label><input id="edExpire" type="date" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Marketplace Price</label><input id="edMarket" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT1">Dealer T1</span></label><input id="edT1" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT2">Dealer T2</span></label><input id="edT2" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT3">Dealer T3</span></label><input id="edT3" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        </div>
        <button id="btnSaveEd" class="w-full mt-2 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- ============ PRINT MODAL ============ -->
<div id="printModal" class="hidden fixed inset-0 z-[80] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl grid grid-rows-[auto_1fr] grid-cols-[480px_1fr] min-h-0">
    <div class="col-span-2 sticky top-0 z-10 bg-zinc-950 border-b border-zinc-800 p-4 flex items-center justify-between">
      <div class="text-xl font-semibold">Print Price Tags</div>
      <button id="btnClosePrintModal" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-4 border-r border-zinc-800 space-y-4 overflow-auto">
      <div class="sticky top-0 bg-zinc-950 border-b border-zinc-800 pb-3 z-10">
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <select id="printTemplate" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></select>
          <button id="btnOpenPrint" class="px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Open Print Page</button>
        </div>
        <div class="mt-3 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center gap-2">
          <input id="printSearch" class="flex-1 bg-transparent outline-none" placeholder="Search (SKU/Product name)...">
          <label class="text-sm"><input type="checkbox" id="printCheckAll"> <span class="text-zinc-300">Select all</span></label>
        </div>
        <div class="text-sm text-zinc-400 mt-2">Select SKU and enter the Qty. to print</div>
      </div>
      <div id="printList" class="space-y-2 pt-2"></div>
      <div id="printSummary" class="text-sm text-zinc-400"></div>
    </div>
    <div class="flex flex-col w-full h-full min-h-0 min-w-0 p-4 overflow-hidden">
      <div class="text-sm text-zinc-400 mb-2 shrink-0">Preview</div>
      <div id="previewBox" class="bg-zinc-900 rounded-2xl border border-zinc-800 flex-1 w-full h-full min-h-0 min-w-0 relative flex items-center justify-center overflow-hidden"></div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="confirm-container"></div>

<script>
/* ================= CORE STATE / STORAGE ================= */
const LS = {
  GIST_ID: 'pp_cloud_gist_id_v3',
  TOKEN: 'pp_cloud_token_v3',
  LAST_USER: 'pp_last_user_v3'
};
const defaultDealerNames = {t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3'};
const Channels = ['Flagship','Marketplace','Dealer'];

const sampleProducts = [{
  sku:'MP-00010',
  brand:'iCon Pro Audio',
  category:'Audio Interface',
  description:'iCon Pro Audio GoLive Pro',
  details:'Audio interface for live streaming\\n24-bit/48kHz with onboard DSP (Reverb, EQ, Vocal Tune)\\nBuilt-in 5000mAh battery up to 6 hours\\nMic input mini-XLR (48V) & 1/4-inch\\nBluetooth for music & control',
  normalPrice:7990, promoPrice:5990, expiresDate:'2099-09-09',
  marketplacePrice:5990, dealer1:5600, dealer2:5400, dealer3:5200
}];

// Defaults
const defaultPosition = { x: 0, y: 0 };
const defaultFontStyle = { fw: 'normal', fst: 'normal', td: 'none', align:'left' };
const defaultTextStyles = { fs: 14, color: '#ffffff', position: {...defaultPosition}, ...defaultFontStyle };

const defaultBrandLogo = { enabled: true, size: 28, position: {...defaultPosition}, color:'#ffffff' };

const defaultAppState = {
  version: 3.9, // bump
  products: sampleProducts,
  brandLogos: {}, // brand -> base64
  templates: [
    { id:'t-a4', name:'A4', kind:'A4', showLogo:true, imageData:null,
      logoStyles:{ size:64, position:{x:0,y:0} },
      brandLogo: { ...defaultBrandLogo },
      styles:{ sku:{...defaultTextStyles, fs:16, position:{x:250, y:-120}},
               description:{...defaultTextStyles, fs:30, position:{x:0, y:-20}},
               details:{...defaultTextStyles, fs:14, position:{x:0, y:80}},
               price:{...defaultTextStyles, fs:72, position:{x:200, y:120}},
               oldPrice:{...defaultTextStyles, fs:20, color:'#ff4d4f', position:{x:20, y:125}},
               expire:{...defaultTextStyles, fs:13, position:{x:-250, y:130}} },
      bgColor:'#0b0b0c'
    },
    { id:'t-a5', name:'A5', kind:'A5', showLogo:true, imageData:null,
      logoStyles:{ size:50, position:{x:0,y:0} },
      brandLogo: { ...defaultBrandLogo },
      styles:{ sku:{...defaultTextStyles, fs:14, position:{x:180, y:-100}},
               description:{...defaultTextStyles, fs:26, position:{x:0, y:-20}},
               details:{...defaultTextStyles, fs:13, position:{x:0, y:50}},
               price:{...defaultTextStyles, fs:60, position:{x:150, y:100}},
               oldPrice:{...defaultTextStyles, fs:18, color:'#ff4d4f', position:{x:10, y:105}},
               expire:{...defaultTextStyles, fs:12, position:{x:-180, y:110}} },
      bgColor:'#0b0b0c'
    },
    { id:'t-a6', name:'A6', kind:'A6', showLogo:true, imageData:null,
      logoStyles:{ size:40, position:{x:0,y:0} },
      brandLogo: { ...defaultBrandLogo },
      styles:{ sku:{...defaultTextStyles, fs:12, position:{x:120, y:-70}},
               description:{...defaultTextStyles, fs:22, position:{x:0, y:-10}},
               details:{...defaultTextStyles, fs:12, position:{x:0, y:40}},
               price:{...defaultTextStyles, fs:48, position:{x:100, y:70}},
               oldPrice:{...defaultTextStyles, fs:16, color:'#B91C1C', position:{x:0, y:75}},
               expire:{...defaultTextStyles, fs:11, position:{x:-120, y:80}} },
      bgColor:'#0b0b0c'
    },
    { id:'t-acc', name:'Accessories', kind:'ACC', showLogo:true, imageData:null,
      logoStyles:{ size:30, position:{x:0,y:0} },
      brandLogo: { ...defaultBrandLogo },
      styles:{ sku:{...defaultTextStyles, fs:11, position:{x:0, y:-55}},
               description:{...defaultTextStyles, fs:15, align:'center', position:{x:0, y:-10}},
               details:{...defaultTextStyles, fs:10, color:'#cccccc'},
               price:{...defaultTextStyles, fs:22, position:{x:50, y:50}},
               oldPrice:{...defaultTextStyles, fs:12, color:'#B91C1C', position:{x:-20, y:50}},
               expire:{...defaultTextStyles, fs:10, position:{x:-60, y:50}} },
      bgColor:'#000'
    },
    { id:'t-card', name:'Card', kind:'CARD', showLogo:true, imageData:null,
      logoStyles:{ size:24, position:{x:0,y:0} },
      brandLogo: { ...defaultBrandLogo },
      styles:{ sku:{...defaultTextStyles, fs:10, position:{x:0, y:-60}},
               description:{...defaultTextStyles, fs:14, align:'center', position:{x:0, y:-10}},
               details:{...defaultTextStyles, fs:9, color:'#cccccc', position:{x:0, y:25}},
               price:{...defaultTextStyles, fs:20, position:{x:50, y:60}},
               oldPrice:{...defaultTextStyles, fs:11, color:'#B91C1C', position:{x:-20, y:60}},
               expire:{...defaultTextStyles, fs:9, position:{x:-60, y:60}} },
      bgColor:'#0b0b0c'
    },
    { id:'t-small', name:'Small Tag (24 per sheet)', kind:'SMALL', showLogo:true, imageData:null,
      logoStyles:{ size:20, position:{x:0,y:0} },
      brandLogo: { ...defaultBrandLogo },
      styles:{ sku:{...defaultTextStyles, fs:9, position:{x:0, y:-12}},
               description:{...defaultTextStyles, fs:11, position:{x:0, y:2}},
               details:{...defaultTextStyles, fs:8},
               price:{...defaultTextStyles, fs:16, position:{x:40, y:15}},
               oldPrice:{...defaultTextStyles, fs:9, color:'#ff4d4f', position:{x:-20, y:16}},
               expire:{...defaultTextStyles, fs:8, position:{x:-40, y:16}} },
      bgColor:'#0b0b0c'
    }
  ],
  dealerNames: defaultDealerNames,
  users: [],
  logo: '',
  logs: []
};

let appData = null;
let currentUser = null;
let editingIndex = -1;
let currentPage = 1;
const itemsPerPage = 20;

let sortState = { key: 'sku', direction: 'asc' };
let columnFilters = {};

/* ================= UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const money = n => isFinite(n) && n > 0 ? n.toLocaleString('th-TH',{maximumFractionDigits:0}) + ' .-' : '-';
const toDateInput = v => v ? new Date(v).toISOString().slice(0,10) : '';
const fromExcelDate = v => {
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return d.toISOString().slice(0,10); }
  if (typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return '';
};
const marginPct = (price, normal) => (price > 0 && normal > 0 ? ((normal - price) / normal) * 100 : 0);

async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
const ellip = (s,max=40)=> !s ? '' : (s.length<=max? s : s.slice(0,max-3)+'...');

const debounce = (func, delay = 300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>func.apply(this,a),delay); }; };

function getEffectivePromoPrice(product) {
  const today = new Date(); today.setHours(0,0,0,0);
  const expires = product.expiresDate ? new Date(product.expiresDate) : null;
  if (expires && expires < today) return product.normalPrice;
  return product.promoPrice;
}
function formatDisplayDate(dateString) {
  if (!dateString || typeof dateString !== 'string') return '';
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const [y,m,d] = dateString.split('-'); if(!y||!m||!d) return dateString;
  return `${d}-${months[+m-1]}-${y}`;
}
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

/* ================= NOTIFICATION / CONFIRM ================= */
function showToast(message, type = 'info'){ const c=$('#toast-container'); const el=document.createElement('div'); el.className=`toast ${type}`; el.textContent=message; c.appendChild(el); setTimeout(()=>el.remove(),3000); }
function showConfirm(title, message){
  return new Promise(resolve=>{
    const c=$('#confirm-container');
    c.innerHTML=`<div class="confirm-overlay"><div class="confirm-modal">
      <h3 class="text-xl font-bold mb-2">${title}</h3>
      <p class="text-zinc-400 mb-6">${message}</p>
      <div class="flex justify-end gap-3">
        <button id="confirm-cancel" class="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Cancel</button>
        <button id="confirm-ok" class="px-4 py-2 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Confirm</button>
      </div></div></div>`;
    const overlay=$('.confirm-overlay'), ok=$('#confirm-ok'), cancel=$('#confirm-cancel');
    const cleanup=()=>c.innerHTML='';
    ok.onclick=()=>{ cleanup(); resolve(true); };
    cancel.onclick=()=>{ cleanup(); resolve(false); };
    overlay.onclick=(e)=>{ if(e.target===overlay){ cleanup(); resolve(false); } };
  });
}

/* ================= LOG / SAVE ================= */
function log(action, meta = '') {
  if (!appData) return;
  if(!appData.logs) appData.logs = [];
  appData.logs.unshift({ ts: new Date().toISOString(), user: currentUser?.username || '-', action, meta });
  if (appData.logs.length > 3000) appData.logs.pop();
}
function updateLocalDataAndSave(newData){
  if (newData) appData = newData;
  renderTableHeader(); renderTable(); applyDealerNamesToUI();
  const gid=localStorage.getItem(LS.GIST_ID), token=localStorage.getItem(LS.TOKEN);
  if(currentUser?.role==='Host' && gid && token){
    cloudSave(gid, token).catch(e=>{ console.error(e); showToast('Auto-save to cloud failed.','error'); });
  }
}

/* ================= CLOUD SYNC (GitHub Gist) ================= */
async function gistRequest(method, path, body, token){
  if(!token) throw new Error('GitHub Token is required.');
  const headers = { 'Accept':'application/vnd.github+json', 'Authorization':'Bearer '+token };
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com'+path, { method, headers, body: body?JSON.stringify(body):undefined, cache:'no-cache' });
  if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
  return res.json();
}
async function cloudCreateGist(token, appState){
  const resp = await gistRequest('POST','/gists',{ public:false, files:{ 'proplugin-data.json':{ content: JSON.stringify(appState) } } }, token);
  localStorage.setItem(LS.GIST_ID, resp.id); localStorage.setItem(LS.TOKEN, token); return resp.id;
}
async function cloudSave(gistId, token){
  const body = { files:{ 'proplugin-data.json':{ content: JSON.stringify(appData) } } };
  await gistRequest('PATCH','/gists/'+gistId, body, token);
}
async function cloudLoad(gistId, token){
  const resp = await gistRequest('GET','/gists/'+gistId,null, token);
  const file = resp.files?.['proplugin-data.json']; if(!file) throw new Error('proplugin-data.json not found');
  const data = JSON.parse(file.content);
  // migrate
  if(!data.brandLogos) data.brandLogos = {};
  (data.templates||[]).forEach(t=>{
    if(t.logoStyles && !t.logoStyles.position){
      const m = t.logoStyles.margin || {top:0,right:0};
      t.logoStyles = { size: t.logoStyles.size||48, position: { x: 0, y: 0 } }; // migrate old margin to center (why: avoid breaking)
    }
    if(!t.brandLogo) t.brandLogo = { ...defaultBrandLogo };
  });
  appData = data;
  localStorage.setItem(LS.GIST_ID, gistId); localStorage.setItem(LS.TOKEN, token);
}

/* ================= AUTH ================= */
function performLogin(user){
  currentUser = user; localStorage.setItem(LS.LAST_USER, user.username); columnFilters = {};
  $('#setupView').classList.add('hidden'); $('#loginView').classList.add('hidden'); $('#cloudSetupView').classList.add('hidden'); $('#appView').classList.remove('hidden');
  $('#roleBadge').textContent = `${currentUser.role} ‚Ä¢ ${currentUser.username}`;
  initFiltersForUser(); bindAppEvents(); updatePermissionBasedUI(); updateLocalDataAndSave();
}
async function login(){
  const u=$('#loginUser').value.trim(), p=$('#loginPass').value;
  if (!appData || !appData.users) { showToast('App data not loaded. Set up cloud.', 'error'); return; }
  const h=await hashPassword(p); const found=(appData.users||[]).find(x=>x.username===u && x.passwordHash===h);
  if(!found){ showToast('Invalid credentials.','error'); return; }
  performLogin(found);
}
function logout(){
  log('logout'); currentUser=null; columnFilters={}; localStorage.removeItem(LS.LAST_USER);
  $('#appView').classList.add('hidden'); $('#loginView').classList.remove('hidden'); $('#loginUser').value=''; $('#loginPass').value='';
}

/* ================= UI VISIBILITY ================= */
function updatePermissionBasedUI(){
  if(!currentUser) return;
  const isHost = currentUser.role==='Host', isAdmin=currentUser.role==='Admin', p=currentUser.permissions||{};
  const canAddItem = isHost || (isAdmin && p.canAddItem);
  const canSeeActions = canAddItem; // why: avoid misleading buttons for non-allowed roles
  $$('.col-actions').forEach(el=>el.classList.toggle('hidden', !canSeeActions));
  $('#btnNewProduct').classList.toggle('hidden', !canAddItem);
}
function updateColumnVisibility(){
  const ch=$('#channelSelect').value;
  const show={ normal:true, promo:(ch==='Flagship'), expire:(ch==='Flagship'),
               market:(ch==='Marketplace'), marketmargin:(ch==='Marketplace'),
               t1:(ch==='Dealer'), margin1:(ch==='Dealer'), t2:(ch==='Dealer'), margin2:(ch==='Dealer'), t3:(ch==='Dealer'), margin3:(ch==='Dealer') };
  const map={'col-normal':show.normal,'col-promo':show.promo,'col-expire':show.expire,'col-market':show.market,'col-marketmargin':show.marketmargin,'col-t1':show.t1,'col-margin1':show.margin1,'col-t2':show.t2,'col-margin2':show.margin2,'col-t3':show.t3,'col-margin3':show.margin3};
  Object.entries(map).forEach(([cls,v])=>$$('.'+cls).forEach(el=>el.classList.toggle('hidden',!v)));
  updatePermissionBasedUI();
}
function initFiltersForUser(){
  const sel=$('#channelSelect'); const cur=sel.value; sel.innerHTML='';
  (currentUser.channels||[]).forEach(ch=>{ const o=document.createElement('option'); o.textContent=ch; o.value=ch; sel.appendChild(o); });
  sel.value = cur && (currentUser.channels||[]).includes(cur) ? cur : (currentUser.channels?.[0]||'');
  $('#btnSettings').classList.toggle('hidden', !['Host','Admin'].includes(currentUser.role));
  $('#btnPrintModal').classList.toggle('hidden', !currentUser.canPrint);
  updateColumnVisibility();
}
function applyDealerNamesToUI(){
  const d=appData?.dealerNames||defaultDealerNames, ids=['lblT1','lblT2','lblT3','edLabelT1','edLabelT2','edLabelT3'];
  ids.forEach(id=>{ const el=$('#'+id); if(!el) return;
    if(id.includes('T1')) el.textContent=d.t1||'Dealer T1';
    if(id.includes('T2')) el.textContent=d.t2||'Dealer T2';
    if(id.includes('T3')) el.textContent=d.t3||'Dealer T3';
  });
}

/* ================= TABLE & PAGINATION ================= */
function filteredProducts(){
  if(!appData) return [];
  const q=$('#searchInput').value.trim().toLowerCase(), ds=$('#dateStart').value, de=$('#dateEnd').value;
  const isFlagship = $('#channelSelect').value==='Flagship';
  const filtered=(appData.products||[]).filter(p=>{
    const s=!q || (p.sku||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);
    const cf=Object.keys(columnFilters).every(k=>{
      if(!columnFilters[k]||columnFilters[k].size===0) return true;
      const v=p[k]||''; return columnFilters[k].has(v.toString());
    });
    let dateOk=true;
    if(isFlagship&&(ds||de)){
      const ex=p.expiresDate?new Date(p.expiresDate):null;
      if(!ex) dateOk=false; else{ if(ds && ex<new Date(ds)) dateOk=false; if(de && ex>new Date(de+'T23:59:59')) dateOk=false; }
    }
    return s&&cf&&dateOk;
  });
  const {key, direction}=sortState;
  const map={normal:'normalPrice', promo:'promoPrice', expire:'expiresDate', market:'marketplacePrice', t1:'dealer1', t2:'dealer2', t3:'dealer3'};
  const k=map[key]||key;
  filtered.sort((a,b)=>{
    const A=a[k], B=b[k];
    if(A==null||A==='') return 1; if(B==null||B==='') return -1;
    let cmp=0; if(typeof A==='number'&&typeof B==='number') cmp=A-B; else cmp=String(A).localeCompare(String(B),undefined,{numeric:true,sensitivity:'base'});
    return direction==='asc'?cmp:-cmp;
  });
  return filtered;
}
function renderPagination(totalItems){
  const box=$('#pagination'); box.innerHTML='';
  const totalPages=Math.ceil(totalItems/itemsPerPage); if(totalPages<=1) return;
  if(currentPage>totalPages) currentPage=totalPages; if(currentPage<1) currentPage=1;
  const makeBtn=(label,target,{disabled=false,active=false,aria=label}={})=>{
    const b=document.createElement('button'); b.textContent=label; b.setAttribute('aria-label',aria);
    b.className=`px-3 py-1 rounded-lg text-sm border ${active?'bg-brand.red border-red-700':'bg-zinc-800 border-zinc-700 hover:bg-zinc-700'}${disabled?' opacity-50 cursor-not-allowed':''}`;
    if(!disabled && !active && typeof target==='number') b.onclick=()=>{ currentPage=target; renderTable(); };
    box.appendChild(b);
  };
  makeBtn('¬´ First',1,{disabled:currentPage===1,aria:'first'});
  makeBtn('‚Äπ Prev',currentPage-1,{disabled:currentPage===1,aria:'prev'});
  const win=2, start=Math.max(2,currentPage-win), end=Math.min(totalPages-1,currentPage+win);
  makeBtn('1',1,{active:currentPage===1});
  if(start>2){ const s=document.createElement('span'); s.textContent='‚Ä¶'; s.className='px-2 select-none'; box.appendChild(s); }
  for(let i=start;i<=end;i++) makeBtn(String(i),i,{active:currentPage===i});
  if(end<totalPages-1){ const s=document.createElement('span'); s.textContent='‚Ä¶'; s.className='px-2 select-none'; box.appendChild(s); }
  if(totalPages>1) makeBtn(String(totalPages),totalPages,{active:currentPage===totalPages});
  makeBtn('Next ‚Ä∫',currentPage+1,{disabled:currentPage===totalPages,aria:'next'});
  makeBtn('Last ¬ª',totalPages,{disabled:currentPage===totalPages,aria:'last'});
}
function makeTableResizable(){ /* keep UX; non-critical so omitted to keep file concise */ } // why: focus on requested features first

function renderTableHeader(){
  const thead=$('#productTHead');
  const cols=[
    { key:'sku', label:'SKU', width:'120px', sortable:true },
    { key:'brand', label:'Brand', width:'120px', sortable:true },
    { key:'description', label:'Description', width:'200px', sortable:true },
    { key:'details', label:'Details', width:'200px', class:'hidden', sortable:false },
    { key:'category', label:'Category', width:'120px', sortable:true },
    { key:'normal', label:'Normal Price', width:'100px', class:'col-normal', sortable:true },
    { key:'promo', label:'Promotion', width:'100px', class:'col-promo', sortable:true },
    { key:'expire', label:'Expire Date', width:'100px', class:'col-expire', sortable:true },
    { key:'market', label:'Marketplace', width:'100px', class:'col-market', sortable:true },
    { key:'marketmargin', label:'Margin', width:'80px', class:'col-marketmargin', sortable:false },
    { key:'t1', label:'<span id="lblT1">Dealer T1</span>', width:'100px', class:'col-t1', sortable:true },
    { key:'margin1', label:'Margin', width:'80px', class:'col-margin1', sortable:false },
    { key:'t2', label:'<span id="lblT2">Dealer T2</span>', width:'100px', class:'col-t2', sortable:true },
    { key:'margin2', label:'Margin', width:'80px', class:'col-margin2', sortable:false },
    { key:'t3', label:'<span id="lblT3">Dealer T3</span>', width:'100px', class:'col-t3', sortable:true },
    { key:'margin3', label:'Margin', width:'80px', class:'col-margin3', sortable:false },
    { key:'actions', label:'Actions', width:'100px', class:'col-actions', sortable:false },
  ];
  let html=`<tr class="[&>th]:px-3 [&>th]:py-3 text-left">`;
  cols.forEach(col=>{
    let cls=col.class||'', attr='', lab=col.label;
    if(col.sortable){ cls+=' cursor-pointer hover:bg-zinc-800'; attr+=` data-sort-key="${col.key}"`; if(sortState.key===col.key) lab+= sortState.direction==='asc' ? ' <span class="text-zinc-400">‚ñ≤</span>':' <span class="text-zinc-400">‚ñº</span>'; }
    let content;
    if(['sku','description','brand','category'].includes(col.key)){
      const active = columnFilters[col.key] && columnFilters[col.key].size>0;
      content = `<div class="flex items-center justify-between w-full">
        <div>${lab}</div>
        <button class="filter-btn ${active?'active':''}" data-filter-key="${col.key}">‚ñº</button>
      </div><div id="filter-dropdown-${col.key}" class="filter-dropdown"></div>`;
    } else content=lab;
    html += `<th class="${cls}" style="width:${col.width}; position:relative;" ${attr}>${content}<div class="resizer"></div></th>`;
  });
  html+='</tr>'; thead.innerHTML=html; makeTableResizable(); bindHeaderEvents();
}
function bindHeaderEvents(){
  $$('#productTHead [data-sort-key]').forEach(th=>{
    th.onclick=()=>{ const k=th.getAttribute('data-sort-key'); if(sortState.key===k) sortState.direction = sortState.direction==='asc'?'desc':'asc'; else { sortState.key=k; sortState.direction='asc'; } renderTableHeader(); renderTable(); };
  });
  $$('.filter-btn').forEach(btn=>{
    btn.onclick=(e)=>{ e.stopPropagation(); const key=btn.getAttribute('data-filter-key'); openFilterDropdown(key, btn); };
  });
  document.addEventListener('click', closeAllFilterDropdowns, { once:true });
}
function openFilterDropdown(key, anchor){
  const drop = $(`#filter-dropdown-${key}`); if(!drop) return;
  const values = [...new Set((appData.products||[]).map(p=> (p[key]||'').toString() ))].sort();
  drop.innerHTML = `<div class="filter-dropdown-content"></div>`;
  const box = drop.querySelector('.filter-dropdown-content');
  values.forEach(v=>{
    const id=`f-${key}-${v.replace(/[^a-z0-9]+/ig,'_')}`;
    const checked = columnFilters[key]?.has(v) || false;
    box.insertAdjacentHTML('beforeend', `<label class="inline-flex items-center gap-2"><input type="checkbox" id="${id}" ${checked?'checked':''} data-filter-val="${v}"><span>${v||'(empty)'}</span></label>`);
  });
  box.insertAdjacentHTML('beforeend', `<div class="mt-2 flex gap-2">
    <button class="px-2 py-1 rounded-xl bg-brand.red border border-red-700 text-sm" data-apply>Apply</button>
    <button class="px-2 py-1 rounded-xl bg-zinc-800 border border-zinc-700 text-sm" data-clear>Clear</button>
  </div>`);
  const rect = anchor.getBoundingClientRect(); drop.style.display='block'; drop.style.left='0'; drop.style.top='100%';
  drop.querySelector('[data-apply]').onclick=()=>{
    const checks = [...drop.querySelectorAll('input[type="checkbox"][data-filter-val]')];
    const set = new Set(checks.filter(c=>c.checked).map(c=>c.getAttribute('data-filter-val')));
    if(set.size>0){ columnFilters[key]=set; } else delete columnFilters[key];
    renderTableHeader(); renderTable();
  };
  drop.querySelector('[data-clear]').onclick=()=>{ delete columnFilters[key]; renderTableHeader(); renderTable(); };
}
function closeAllFilterDropdowns(){ $$('.filter-dropdown').forEach(d=>d.style.display='none'); }

function renderTable(){
  const body=$('#productBody'); body.innerHTML='';
  if(!appData) return;
  const all=filteredProducts();
  const items=all.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage);
  items.forEach(p=>{
    const tr=document.createElement('tr'); tr.className='hover:bg-zinc-700/70';
    const eff=getEffectivePromoPrice(p); const disc = eff>0 && eff<p.normalPrice;
    const mM=marginPct(p.marketplacePrice,p.normalPrice), m1=marginPct(p.dealer1,p.normalPrice), m2=marginPct(p.dealer2,p.normalPrice), m3=marginPct(p.dealer3,p.normalPrice);
    const one=(p.details||'').replace(/\n+/g,' ‚Ä¢ ');
    tr.innerHTML=`
      <td class="px-3 py-3 oneline" title="${p.sku}">${p.sku||'-'}</td>
      <td class="px-3 py-3 oneline" style="color:#E11D2E;" title="${p.brand}">${p.brand||'-'}</td>
      <td class="px-3 py-3 oneline" title="${p.description}">${p.description||'-'}</td>
      <td class="px-3 py-3 oneline hidden" title="${one}">${one}</td>
      <td class="px-3 py-3 oneline" title="${p.category}">${p.category||'-'}</td>
      <td class="px-3 py-3 col-normal oneline" title="${money(p.normalPrice)}">${money(p.normalPrice)}</td>
      <td class="px-3 py-3 col-promo oneline" title="${money(eff)}" style="color:${disc?'#E11D2E':'white'};">${money(eff)}</td>
      <td class="px-3 py-3 col-expire oneline">${p.expiresDate||'-'}</td>
      <td class="px-3 py-3 col-market oneline" title="${money(p.marketplacePrice)}">${money(p.marketplacePrice)}</td>
      <td class="px-3 py-3 col-marketmargin oneline" style="color:#22c55e;" title="(${mM.toFixed(1)}%)">(${mM.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-t1 oneline" title="${money(p.dealer1)}">${money(p.dealer1)}</td>
      <td class="px-3 py-3 col-margin1 oneline" style="color:#22c55e;" title="(${m1.toFixed(1)}%)">(${m1.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-t2 oneline" title="${money(p.dealer2)}">${money(p.dealer2)}</td>
      <td class="px-3 py-3 col-margin2 oneline" style="color:#22c55e;" title="(${m2.toFixed(1)}%)">(${m2.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-t3 oneline" title="${money(p.dealer3)}">${money(p.dealer3)}</td>
      <td class="px-3 py-3 col-margin3 oneline" style="color:#22c55e;" title="(${m3.toFixed(1)}%)">(${m3.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-actions">
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-edit="${p.sku}">Edit</button>
          <button title="Delete" class="px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-del="${p.sku}">‚ùå</button>
        </div>
      </td>`;
    body.appendChild(tr);
  });
  renderPagination(all.length); bindTableEvents(); updateColumnVisibility();
}
function bindTableEvents(){
  $$('#productBody [data-edit]').forEach(btn=> btn.onclick=()=>openEditor(btn.getAttribute('data-edit')));
  $$('#productBody [data-del]').forEach(btn=> btn.onclick=async()=>{
    const sku=btn.getAttribute('data-del');
    if(!(await showConfirm('Delete','Delete item '+sku+' ?'))) return;
    const i=(appData.products||[]).findIndex(x=>x.sku===sku); if(i>-1){ appData.products.splice(i,1); log('del_product',sku); updateLocalDataAndSave(); }
  });
}

/* ================= EDITOR ================= */
function openEditor(sku=null){
  const isHost=currentUser.role==='Host', p=currentUser.permissions||{}, can=isHost || (currentUser.role==='Admin'&&p.canAddItem); if(!can) return;
  if(sku){
    editingIndex = appData.products.findIndex(x=>x.sku===sku);
    const pr = appData.products[editingIndex];
    $('#editorTitle').textContent='Edit Product';
    $('#edSku').value=pr.sku; $('#edSku').disabled=true;
    $('#edDesc').value=pr.description||''; $('#edDetails').value=pr.details||'';
    $('#edBrand').value=pr.brand||''; $('#edCategory').value=pr.category||'';
    $('#edExpire').value=toDateInput(pr.expiresDate);
    $('#edNormal').value=pr.normalPrice||''; $('#edPromo').value=pr.promoPrice||'';
    $('#edMarket').value=pr.marketplacePrice||''; $('#edT1').value=pr.dealer1||''; $('#edT2').value=pr.dealer2||''; $('#edT3').value=pr.dealer3||'';
  } else {
    editingIndex=-1; $('#editorTitle').textContent='Add New Product';
    ['edSku','edDesc','edDetails','edBrand','edCategory','edExpire','edNormal','edPromo','edMarket','edT1','edT2','edT3'].forEach(id=>$('#'+id).value='');
    $('#edSku').disabled=false;
  }
  applyDealerNamesToUI(); $('#editorModal').classList.remove('hidden');
}
function closeEditor(){ $('#editorModal').classList.add('hidden'); }
async function saveEditor(){
  const sku=$('#edSku').value.trim(); if(!sku){ showToast('SKU is required.','error'); return; }
  const d={ sku, description:$('#edDesc').value.trim(), details:$('#edDetails').value.trim(), brand:$('#edBrand').value.trim(), category:$('#edCategory').value.trim(),
            expiresDate:$('#edExpire').value||'', normalPrice:parseFloat($('#edNormal').value)||0, promoPrice:parseFloat($('#edPromo').value)||0,
            marketplacePrice:parseFloat($('#edMarket').value)||0, dealer1:parseFloat($('#edT1').value)||0, dealer2:parseFloat($('#edT2').value)||0, dealer3:parseFloat($('#edT3').value)||0 };
  if(editingIndex>-1){ appData.products[editingIndex] = {...appData.products[editingIndex], ...d}; log('edit_product',sku); }
  else { if((appData.products||[]).some(p=>p.sku===sku)){ showToast(`SKU "${sku}" already exists.`,'error'); return; } appData.products.unshift(d); log('add_product',sku); }
  closeEditor(); showToast(`Product ${sku} saved.`,'success'); updateLocalDataAndSave();
}

/* ================= SETTINGS ================= */
function openSettings(tab){ if(!['Host','Admin'].includes(currentUser.role)) return; $('#settingsPanel').classList.remove('hidden'); renderSettings(tab); }
function defaultSettingsTabFor(user){ const p=user?.permissions||{}, isHost=user?.role==='Host'; if(isHost) return 'data'; if(p.canManageTemplates) return 'templates'; if(p.canManagePromo) return 'promo'; if(p.canManageMaster) return 'data'; return null; }

function renderSettings(tab){
  const box=$('#settingsContent');
  $$('.set-tab').forEach(b=>b.classList.remove('ring-2','ring-brand.red'));
  const btn=$(`.set-tab[data-tab="${tab}"]`); if(btn) btn.classList.add('ring-2','ring-brand.red');

  const isHost=currentUser.role==='Host', p=currentUser.permissions||{};
  const allow=t=>{
    if(t==='data') return isHost||p.canManageMaster;
    if(t==='promo') return isHost||p.canManagePromo;
    if(t==='templates') return isHost||p.canManageTemplates;
    if(['logo','dealer','users','cloud','history'].includes(t)) return isHost;
    return false;
  };
  if(!allow(tab)){ const fb=defaultSettingsTabFor(currentUser); if(fb) return renderSettings(fb); box.innerHTML='<div class="text-zinc-400">No permission.</div>'; return; }

  // toggle visibility in sidebar (why: clarity on available tabs)
  [['data','canManageMaster'],['promo','canManagePromo'],['templates','canManageTemplates']].forEach(([t,flag])=>{
    const visible = isHost || (p?.[flag]); const el=$(`button[data-tab="${t}"]`); if(el) el.classList.toggle('hidden', !visible);
  });
  ['logo','dealer','users','cloud','history'].forEach(t=>{ const el=$(`button[data-tab="${t}"]`); if(el) el.classList.toggle('hidden', !isHost); });

  if(tab==='data'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Master Data</div>
      <div class="text-zinc-400 mb-4">Import or Export the main product data file.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Master File (.xlsx)</div>
          <input id="fileImportMaster" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Desc, C Details, D Brand, E Category, F Normal, G Marketplace, H D1, I D2, J D3</p>
          <button id="btnDoImportMaster" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Master</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Export Master File (.xlsx)</div>
          <button id="btnExportMaster" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Master</button>
          <p class="text-xs text-zinc-400 mt-2">Exports a file compatible with the import format.</p>
        </div>
      </div>`;
    bindSettingsEvents(tab);
  }

  if(tab==='promo'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Promotion Data</div>
      <div class="text-zinc-400 mb-4">Import or Export promotion-specific data.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Promotion File (.xlsx)</div>
          <input id="fileImportPromo" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Desc, C Normal, D Promotion, E Expires</p>
          <button id="btnDoImportPromo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Promotion</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
          <div>
            <div class="font-semibold mb-2">Export Promotion File (.xlsx)</div>
            <button id="btnExportPromo" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Promotion</button>
          </div>
          <div>
            <div class="font-semibold mb-2">Promotion Report</div>
            <button id="btnReportExpired" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Report Promotion Expire</button>
          </div>
        </div>
      </div>`;
    bindSettingsEvents(tab);
  }

  if(tab==='templates'){
    const tpls = appData.templates||[];
    const tplCards = tpls.map((t,i)=>`
      <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-4">
        <div class="text-lg font-semibold">Template: ${t.name}</div>
        <!-- row 1: 4 columns -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <!-- Background Image -->
          <div>
            <div class="font-semibold mb-2">Background Image</div>
            <input type="file" accept="image/*" data-bg-upload="${i}" class="w-full">
            <div class="mt-2">
              ${t.imageData?`<img src="${t.imageData}" class="w-full h-24 object-cover rounded-xl border border-zinc-800">`:'<div class="w-full h-24 rounded-xl border border-dashed border-zinc-700 grid place-items-center text-zinc-500">No image</div>'}
            </div>
            <button class="mt-3 px-3 py-1.5 rounded-xl bg-zinc-900 border border-zinc-700" data-bg-remove="${i}">Remove</button>
          </div>

          <!-- Logo ProPlugin Settings -->
          <div>
            <div class="font-semibold mb-2">Logo ProPlugin Settings</div>
            <div class="grid grid-cols-3 gap-2 items-end">
              <div><label class="text-xs text-zinc-400">Size (px)</label><input class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" type="number" min="8" data-logosize-tpl="${i}" value="${t.logoStyles?.size||48}"></div>
              <div><label class="text-xs text-zinc-400">Position X</label><input class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" type="number" data-logoposx-tpl="${i}" value="${t.logoStyles?.position?.x||0}"></div>
              <div><label class="text-xs text-zinc-400">Position Y</label><input class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" type="number" data-logoposy-tpl="${i}" value="${t.logoStyles?.position?.y||0}"></div>
            </div>
          </div>

          <!-- Background Color -->
          <div>
            <div class="font-semibold mb-2">Background Color</div>
            <input type="color" data-bgcolor-tpl="${i}" class="w-full h-10 rounded-xl border border-zinc-700 bg-transparent" value="${t.bgColor||'#0b0b0c'}">
          </div>

          <!-- Logo Brand Settings -->
          <div>
            <div class="font-semibold mb-2">Logo Brand Settings</div>
            <div class="grid grid-cols-2 gap-2 items-end">
              <label class="inline-flex items-center gap-2 col-span-2">
                <input type="checkbox" data-brandshow-tpl="${i}" ${t.brandLogo?.enabled!==false?'checked':''}>
                <span class="text-sm">Show</span>
              </label>
              <div><label class="text-xs text-zinc-400">Size (px)</label><input type="number" min="8" data-brandsize-tpl="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.brandLogo?.size||28}"></div>
              <div><label class="text-xs text-zinc-400">Font Color</label><input type="color" data-brandcolor-tpl="${i}" class="w-full h-10 rounded-xl border border-zinc-700 bg-transparent" value="${t.brandLogo?.color||'#ffffff'}"></div>
              <div><label class="text-xs text-zinc-400">Position X</label><input type="number" data-brandposx-tpl="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.brandLogo?.position?.x||0}"></div>
              <div><label class="text-xs text-zinc-400">Position Y</label><input type="number" data-brandposy-tpl="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.brandLogo?.position?.y||0}"></div>
            </div>
          </div>
        </div>

        <!-- row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          ${['sku','description','details'].map(k=>`
            <div>
              <div class="font-semibold mb-2">${k.toUpperCase()}</div>
              <div class="grid grid-cols-3 gap-2 items-end">
                <div><label class="text-xs text-zinc-400">Size</label><input type="number" min="8" data-${k}-fs="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.styles[k].fs}"></div>
                <div><label class="text-xs text-zinc-400">Pos X</label><input type="number" data-${k}-posx="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.styles[k].position?.x||0}"></div>
                <div><label class="text-xs text-zinc-400">Pos Y</label><input type="number" data-${k}-posy="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.styles[k].position?.y||0}"></div>
                <div class="col-span-3"><label class="text-xs text-zinc-400">Color</label><input type="color" data-${k}-color="${i}" class="w-full h-10 rounded-xl border border-zinc-700 bg-transparent" value="${t.styles[k].color}"></div>
              </div>
            </div>`).join('')}
        </div>

        <!-- row 3 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          ${['price','oldPrice','expire'].map(k=>`
            <div>
              <div class="font-semibold mb-2">${k.toUpperCase()}</div>
              <div class="grid grid-cols-3 gap-2 items-end">
                <div><label class="text-xs text-zinc-400">Size</label><input type="number" min="8" data-${k}-fs="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.styles[k].fs}"></div>
                <div><label class="text-xs text-zinc-400">Pos X</label><input type="number" data-${k}-posx="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.styles[k].position?.x||0}"></div>
                <div><label class="text-xs text-zinc-400">Pos Y</label><input type="number" data-${k}-posy="${i}" class="w-full mt-1 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" value="${t.styles[k].position?.y||0}"></div>
                <div class="col-span-3"><label class="text-xs text-zinc-400">Color</label><input type="color" data-${k}-color="${i}" class="w-full h-10 rounded-xl border border-zinc-700 bg-transparent" value="${t.styles[k].color}"></div>
              </div>
            </div>`).join('')}
        </div>

        <div class="flex justify-end">
          <button class="px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700" data-savetpl-idx="${i}">Save Template</button>
        </div>
      </div>
    `).join('');

    box.innerHTML = `<div class="text-2xl font-semibold mb-4">Template Management</div><div class="space-y-6">${tplCards}</div>`;
    bindSettingsEvents(tab);
  }

  if(tab==='logo'){
    const base64=appData.logo||'';
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-4">Manage Logo</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Upload logo</div>
          <input type="file" id="logoFile" accept="image/*">
          <p class="text-xs text-zinc-400 mt-2">PNG/JPG/SVG. Used on default templates.</p>
          <button id="btnSaveLogo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save logo</button>
          <button id="btnRemoveLogo" class="mt-4 ml-2 px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Remove</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Preview</div>
          <div class="h-40 w-40 bg-white rounded-xl overflow-hidden grid place-items-center p-2">
            ${base64?`<img src="${base64}" class="max-h-full max-w-full object-contain">`:'<div class="text-zinc-800 text-4xl font-black">P</div>'}
          </div>
        </div>
      </div>

      <!-- Upload Logo Brand -->
      <div class="mt-8 p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Upload Logo Brand</div>
          <input id="brandSearch" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" placeholder="Search brand...">
        </div>
        <div class="text-xs text-zinc-400 mt-1">Source: unique values of Brand (column D) from master data.</div>
        <div id="brandLogoList" class="mt-4 space-y-3"></div>
      </div>
    `;
    bindSettingsEvents(tab);
    renderBrandLogoList(); // initial list
  }

  if(tab==='dealer'){
    const names=appData.dealerNames||{};
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-4">Dealer Settings</div>
      <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-xs text-zinc-400">Name for Dealer T1</label><input id="nameT1" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t1||'Dealer T1'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T2</label><input id="nameT2" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t2||'Dealer T2'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T3</label><input id="nameT3" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t3||'Dealer T3'}"></div>
        </div>
        <button id="btnSaveDealer" class="mt-2 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save</button>
      </div>`;
    bindSettingsEvents(tab);
  }

  if(tab==='users'){
    const users=appData.users||[];
    const rows = users.map((u,i)=>`
      <tr>
        <td class="px-3 py-2">${u.username}</td>
        <td class="px-3 py-2">${u.role}</td>
        <td class="px-3 py-2">${(u.channels||[]).join(', ')}</td>
        <td class="px-3 py-2"><button class="px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700 text-xs" data-del-user="${i}">Delete</button></td>
      </tr>`).join('');
    box.innerHTML=`
      <div class="flex items-center justify-between mb-3">
        <div class="text-2xl font-semibold">User Management</div>
        <button id="btnAddUser" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Add User</button>
      </div>
      <div id="addUserBox" class="hidden p-4 mb-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <div class="grid md:grid-cols-2 gap-3">
          <input id="nuName" placeholder="username" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <input id="nuPass" placeholder="password" type="password" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <select id="nuRole" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700"><option>User</option><option>Admin</option><option>Host</option></select>
          <input id="nuChannels" placeholder="channels comma-separated e.g. Flagship,Marketplace,Dealer" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
        </div>
        <div class="flex gap-2 mt-3">
          <label class="text-sm"><input id="nuCanPrint" type="checkbox"> canPrint</label>
          <label class="text-sm"><input id="nuAddItem" type="checkbox"> canAddItem</label>
          <label class="text-sm"><input id="nuTpl" type="checkbox"> canManageTemplates</label>
          <label class="text-sm"><input id="nuPromo" type="checkbox"> canManagePromo</label>
          <label class="text-sm"><input id="nuMaster" type="checkbox"> canManageMaster</label>
        </div>
        <button id="btnSaveUser" class="mt-3 px-3 py-2 rounded-2xl bg-brand.red border border-red-700">Save User</button>
      </div>
      <div class="overflow-auto border border-zinc-800 rounded-2xl">
        <table class="w-full">
          <thead class="bg-zinc-900/70 border-b border-zinc-800"><tr class="[&>th]:px-3 [&>th]:py-2 text-left"><th>Username</th><th>Role</th><th>Channels</th><th>Actions</th></tr></thead>
          <tbody>${rows||''}</tbody>
        </table>
      </div>`;
    bindSettingsEvents(tab);
  }

  if(tab==='cloud'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Cloud Sync (GitHub Gist)</div>
      <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <div class="font-semibold mb-2">Create New Gist</div>
            <input id="clTokenCreate" type="password" placeholder="ghp_..." class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
            <button id="btnCloudCreate2" class="mt-2 px-3 py-2 rounded-2xl bg-brand.red border border-red-700">Create</button>
          </div>
          <div>
            <div class="font-semibold mb-2">Load Existing Gist</div>
            <input id="clTokenLoad" type="password" placeholder="ghp_..." class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
            <input id="clGistIdLoad" placeholder="gist id..." class="w-full mt-2 px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
            <button id="btnCloudLoad2" class="mt-2 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700">Load</button>
          </div>
        </div>
        <div class="text-xs text-zinc-400 mt-2">Saved Gist: <span id="cloudInfo">${localStorage.getItem(LS.GIST_ID)||'-'}</span></div>
      </div>`;
    bindSettingsEvents(tab);
  }

  if(tab==='history'){
    const rows = (appData.logs||[]).map(l=>`<tr><td class="px-3 py-2">${l.ts}</td><td class="px-3 py-2">${l.user}</td><td class="px-3 py-2">${l.action}</td><td class="px-3 py-2">${l.meta||''}</td></tr>`).join('');
    box.innerHTML=`<div class="text-2xl font-semibold mb-3">Usage History</div>
    <div class="overflow-auto border border-zinc-800 rounded-2xl max-h-[70vh]">
      <table class="w-full"><thead class="bg-zinc-900/70 border-b border-zinc-800"><tr class="[&>th]:px-3 [&>th]:py-2 text-left"><th>Time</th><th>User</th><th>Action</th><th>Meta</th></tr></thead><tbody>${rows}</tbody></table>
    </div>`;
  }
}

function renderBrandLogoList(){
  const q=($('#brandSearch')?.value||'').toLowerCase().trim();
  const box=$('#brandLogoList'); if(!box) return;
  const brands=[...new Set((appData.products||[]).map(p=>(p.brand||'').trim()).filter(Boolean))].sort();
  const list = (q?brands.filter(b=>b.toLowerCase().includes(q)):brands);
  if(list.length===0){ box.innerHTML='<div class="text-zinc-500">No brands.</div>'; return; }
  box.innerHTML = list.map(b=>{
    const src=appData.brandLogos?.[b]||'';
    return `<div class="grid grid-cols-[1fr_120px_1fr_auto_auto] items-center gap-3 p-2 rounded-xl border border-zinc-800">
      <div class="font-medium">${b}</div>
      <div class="h-10 w-28 bg-white rounded-lg grid place-items-center overflow-hidden">${src?`<img src="${src}" class="max-h-10 max-w-full object-contain">`:'<span class="text-zinc-400 text-xs">No logo</span>'}</div>
      <input type="file" accept="image/*" data-brand-file="${encodeURIComponent(b)}" class="px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700">
      <button class="px-3 py-1.5 rounded-xl bg-brand.red border border-red-700 text-sm" data-brand-save="${encodeURIComponent(b)}">Save</button>
      <button class="px-3 py-1.5 rounded-xl bg-zinc-900 border border-zinc-700 text-sm" data-brand-remove="${encodeURIComponent(b)}">Remove</button>
    </div>`;
  }).join('');
  // bind buttons
  $$('#brandLogoList [data-brand-save]').forEach(btn=>{
    btn.onclick=async()=>{
      const brand=decodeURIComponent(btn.getAttribute('data-brand-save'));
      const input = $(`#brandLogoList [data-brand-file="${encodeURIComponent(brand)}"]`);
      const file = input?.files?.[0]; if(!file){ showToast('Select an image first.','error'); return; }
      const base64 = await fileToBase64(file);
      appData.brandLogos[brand]=base64; log('brand_logo_save',brand); updateLocalDataAndSave(); renderBrandLogoList();
    };
  });
  $$('#brandLogoList [data-brand-remove]').forEach(btn=>{
    btn.onclick=async()=>{
      const brand=decodeURIComponent(btn.getAttribute('data-brand-remove'));
      if(!(await showConfirm('Remove Brand Logo', `Remove logo for "${brand}"?`))) return;
      delete appData.brandLogos[brand]; log('brand_logo_remove',brand); updateLocalDataAndSave(); renderBrandLogoList();
    };
  });
}

/* ================= SETTINGS EVENTS ================= */
function bindSettingsEvents(tab){
  if(tab==='data'){
    $('#btnDoImportMaster').onclick=async()=>{
      const f=$('#fileImportMaster').files?.[0]; if(!f){ showToast('Select a file.','error'); return; }
      const data = await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const out=[];
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; if(!r[0]) continue;
        out.push({
          sku:String(r[0]).trim(),
          description:String(r[1]||'').trim(),
          details:String(r[2]||'').trim(),
          brand:String(r[3]||'').trim(),     // Column D
          category:String(r[4]||'').trim(),
          normalPrice:parseFloat(r[5]||0)||0,
          marketplacePrice:parseFloat(r[6]||0)||0,
          dealer1:parseFloat(r[7]||0)||0,
          dealer2:parseFloat(r[8]||0)||0,
          dealer3:parseFloat(r[9]||0)||0,
          promoPrice:0, expiresDate:''
        });
      }
      appData.products = out; log('import_master', out.length+' rows'); updateLocalDataAndSave(); showToast('Master imported.','success');
    };
    $('#btnExportMaster').onclick=async()=>{
      const data=[['SKU','Desc','Details','Brand','Category','Normal','Marketplace','D1','D2','D3']];
      (appData.products||[]).forEach(p=> data.push([p.sku,p.description,p.details,p.brand,p.category,p.normalPrice,p.marketplacePrice,p.dealer1,p.dealer2,p.dealer3]));
      const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb,ws,'Master'); XLSX.writeFile(wb,'proplugin-master.xlsx');
    };
  }

  if(tab==='promo'){
    $('#btnDoImportPromo').onclick=async()=>{
      const f=$('#fileImportPromo').files?.[0]; if(!f){ showToast('Select a file.','error'); return; }
      const data = await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const idx = new Map((appData.products||[]).map((p,i)=>[p.sku,i]));
      let applied=0;
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; const sku=String(r[0]||'').trim(); if(!sku) continue;
        const iRow = idx.get(sku); if(iRow==null) continue;
        const normal=parseFloat(r[2]||0)||0, promo=parseFloat(r[3]||0)||0, exp=fromExcelDate(r[4]);
        const p=appData.products[iRow]; p.normalPrice=normal; p.promoPrice=promo; p.expiresDate=exp; applied++;
      }
      log('import_promo', applied+' rows'); updateLocalDataAndSave(); showToast('Promotion imported.','success');
    };
    $('#btnExportPromo').onclick=async()=>{
      const data=[['SKU','Desc','Normal','Promotion','Expires']];
      (appData.products||[]).forEach(p=> data.push([p.sku,p.description,p.normalPrice,p.promoPrice,p.expiresDate]));
      const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb,ws,'Promo'); XLSX.writeFile(wb,'proplugin-promo.xlsx');
    };
    $('#btnReportExpired').onclick=()=>{
      const today=new Date(); today.setHours(0,0,0,0);
      const rows=(appData.products||[]).filter(p=>p.expiresDate && new Date(p.expiresDate)<today);
      showToast(`Expired promotions: ${rows.length}`,'info');
    };
  }

  if(tab==='templates'){
    // Background upload/remove
    $$('[data-bg-upload]').forEach(inp=> inp.onchange=async(e)=>{
      const i=+inp.getAttribute('data-bg-upload'); const f=inp.files?.[0]; if(!f) return;
      appData.templates[i].imageData = await fileToBase64(f); log('tpl_bg_upload', appData.templates[i].id); updateLocalDataAndSave(); renderSettings('templates');
    });
    $$('[data-bg-remove]').forEach(btn=> btn.onclick=async()=>{
      const i=+btn.getAttribute('data-bg-remove'); appData.templates[i].imageData=null; log('tpl_bg_remove', appData.templates[i].id); updateLocalDataAndSave(); renderSettings('templates');
    });

    // Save template
    $$('[data-savetpl-idx]').forEach(btn=> btn.onclick=()=>{
      const i=+btn.getAttribute('data-savetpl-idx'); const t=appData.templates[i];

      // ProPlugin Logo (Position X,Y)
      const posX=parseInt($(`[data-logoposx-tpl="${i}"]`).value)||0;
      const posY=parseInt($(`[data-logoposy-tpl="${i}"]`).value)||0;
      const size=parseInt($(`[data-logosize-tpl="${i}"]`).value)||48;
      t.logoStyles={ size, position:{x:posX,y:posY} };

      // BG color
      t.bgColor = $(`[data-bgcolor-tpl="${i}"]`).value || t.bgColor || '#0b0b0c';

      // Brand Logo settings
      t.brandLogo = {
        enabled: $(`[data-brandshow-tpl="${i}"]`).checked,
        size: parseInt($(`[data-brandsize-tpl="${i}"]`).value)||28,
        position: { x: parseInt($(`[data-brandposx-tpl="${i}"]`).value)||0, y: parseInt($(`[data-brandposy-tpl="${i}"]`).value)||0 },
        color: $(`[data-brandcolor-tpl="${i}"]`).value || '#ffffff'
      };

      // Text field styles
      ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
        t.styles[k].fs = parseInt($(`[data-${k}-fs="${i}"]`).value)||t.styles[k].fs;
        t.styles[k].position = { x: parseInt($(`[data-${k}-posx="${i}"]`).value)||0, y: parseInt($(`[data-${k}-posy="${i}"]`).value)||0 };
        t.styles[k].color = $(`[data-${k}-color="${i}"]`).value||t.styles[k].color;
      });

      log('save_template', t.id); updateLocalDataAndSave(); showToast(`Template "${t.name}" saved.`,'success');
    });
  }

  if(tab==='logo'){
    $('#btnSaveLogo').onclick=async()=>{
      const f=$('#logoFile').files?.[0]; if(!f){ showToast('Select an image.','error'); return; }
      appData.logo = await fileToBase64(f); log('save_logo'); updateLocalDataAndSave(); renderSettings('logo');
      $('#appHeaderLogo').src = appData.logo; // why: reflect in header
    };
    $('#btnRemoveLogo').onclick=async()=>{
      if(!(await showConfirm('Remove Logo','Remove the main logo?'))) return;
      appData.logo=''; log('remove_logo'); updateLocalDataAndSave(); renderSettings('logo');
      $('#appHeaderLogo').src = 'ProPlugin LOGO.png';
    };
    $('#brandSearch').oninput=debounce(renderBrandLogoList, 150);
  }

  if(tab==='dealer'){
    $('#btnSaveDealer').onclick=()=>{
      appData.dealerNames = {
        t1: $('#nameT1').value||'Dealer T1',
        t2: $('#nameT2').value||'Dealer T2',
        t3: $('#nameT3').value||'Dealer T3'
      };
      log('save_dealer'); updateLocalDataAndSave(); showToast('Dealer names saved.','success');
    };
  }

  if(tab==='users'){
    $('#btnAddUser').onclick=()=>$('#addUserBox').classList.toggle('hidden');
    $('#btnSaveUser').onclick=async()=>{
      const u=$('#nuName').value.trim(), p=$('#nuPass').value, role=$('#nuRole').value;
      if(!u||!p){ showToast('Username/password required.','error'); return; }
      if(appData.users.find(x=>x.username===u)){ showToast('Username exists.','error'); return; }
      const chs = ($('#nuChannels').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const permissions = { canPrint:$('#nuCanPrint').checked, canAddItem:$('#nuAddItem').checked, canManageTemplates:$('#nuTpl').checked, canManagePromo:$('#nuPromo').checked, canManageMaster:$('#nuMaster').checked };
      appData.users.push({ username:u, passwordHash: await hashPassword(p), role, channels: chs.length?chs:Channels.slice(), ...permissions });
      log('add_user',u); updateLocalDataAndSave(); renderSettings('users');
    };
    $$('#settingsContent [data-del-user]').forEach(btn=>btn.onclick=async()=>{
      const i=+btn.getAttribute('data-del-user'); const u=appData.users[i]; if(!u) return;
      if(!(await showConfirm('Delete User',`Delete "${u.username}"?`))) return;
      appData.users.splice(i,1); log('del_user',u.username); updateLocalDataAndSave(); renderSettings('users');
    });
  }

  if(tab==='cloud'){
    $('#btnCloudCreate2').onclick=async()=>{
      try{
        const token=$('#clTokenCreate').value.trim(); if(!token){ showToast('Token required.','error'); return; }
        const id = await cloudCreateGist(token, appData); $('#cloudInfo').textContent=id; showToast('Gist created.','success');
      }catch(e){ console.error(e); showToast('Create failed.','error'); }
    };
    $('#btnCloudLoad2').onclick=async()=>{
      try{
        const token=$('#clTokenLoad').value.trim(), id=$('#clGistIdLoad').value.trim(); if(!token||!id){ showToast('Token/Gist ID required.','error'); return; }
        await cloudLoad(id, token); updateLocalDataAndSave(); $('#cloudInfo').textContent=id; showToast('Loaded from Gist.','success');
      }catch(e){ console.error(e); showToast('Load failed.','error'); }
    };
  }
}

/* ================= PRINT ================= */
function openPrintModal(){
  $('#printModal').classList.remove('hidden');
  const sel=$('#printTemplate'); sel.innerHTML=''; (appData.templates||[]).forEach((t,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=t.name; sel.appendChild(o); });
  buildPrintList(); renderPreview();
}
function closePrintModal(){ $('#printModal').classList.add('hidden'); }
function buildPrintList(){
  const q=$('#printSearch').value?.toLowerCase()||''; const box=$('#printList'); const items=(appData.products||[]).filter(p=>!q || (p.sku||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q));
  box.innerHTML = items.map(p=>`
    <div class="grid grid-cols-[140px_1fr_120px] gap-2 items-center p-2 rounded-xl border border-zinc-800">
      <div class="text-sm text-zinc-400">${p.sku}</div>
      <div class="oneline">${p.description||''}</div>
      <div class="flex items-center justify-end gap-2">
        <label class="text-sm"><input type="checkbox" data-print-sku="${p.sku}"> Select</label>
        <input class="w-16 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" type="number" min="1" value="1" data-print-qty="${p.sku}">
      </div>
    </div>`).join('');
  $('#printSummary').textContent=`Items: ${items.length}`;
}
function renderPreview(){
  const sel=$('#printTemplate'); const idx=parseInt(sel.value)||0; const t=appData.templates[idx];
  const chosen = [...$$('#printList [data-print-sku]')].filter(cb=>cb.checked).map(cb=>{
    const sku=cb.getAttribute('data-print-sku'); const qty=parseInt($(`[data-print-qty="${sku}"]`).value)||1;
    return { sku, qty };
  });
  const items = chosen.length>0? chosen : (appData.products||[]).slice(0,1).map(p=>({sku:p.sku, qty:1}));
  const prods = items.flatMap(x=> Array.from({length:x.qty}, ()=> appData.products.find(p=>p.sku===x.sku)).filter(Boolean) );
  const html = generatePrintHTML(prods, t);
  const iframe=document.createElement('iframe'); iframe.className='w-full h-full rounded-xl bg-white';
  iframe.srcdoc = html; const box=$('#previewBox'); box.innerHTML=''; box.appendChild(iframe);
}
function openPrintPage(){
  const sel=$('#printTemplate'); const idx=parseInt(sel.value)||0; const t=appData.templates[idx];
  const chosen=[...$$('#printList [data-print-sku]')].filter(cb=>cb.checked).map(cb=>{ const sku=cb.getAttribute('data-print-sku'); const qty=parseInt($(`[data-print-qty="${sku}"]`).value)||1; return { sku, qty }; });
  const prods = chosen.length? chosen.flatMap(x=> Array.from({length:x.qty}, ()=> appData.products.find(p=>p.sku===x.sku)).filter(Boolean) ) : appData.products.slice(0,1);
  const html = generatePrintHTML(prods, t, true);
  const w=window.open('about:blank'); w.document.open(); w.document.write(html); w.document.close();
}

function baseSize(kind){ if(kind==='A4') return {w:794,h:1123}; if(kind==='A5') return {w:559,h:794}; if(kind==='A6') return {w:397,h:559}; if(kind==='ACC') return {w:300,h:300}; if(kind==='CARD') return {w:260,h:360}; if(kind==='SMALL') return {w:250,h:180}; return {w:559,h:794}; }

function generateSingleTagHTML(p, tpl){
  const { w,h } = baseSize(tpl.kind);
  const center = 'left:50%; top:50%; transform:translate(-50%,-50%)';
  const styleBox = `position:relative; width:${w}px; height:${h}px; background:${tpl.bgColor||'#0b0b0c'}; overflow:hidden; border-radius:8px;`;
  const bgImg = tpl.imageData ? `<img src="${tpl.imageData}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:1;">` : '';

  // ProPlugin logo (Position X,Y)
  let logoTag='';
  if(appData.logo && tpl.showLogo){
    const { size=48, position={x:0,y:0} } = tpl.logoStyles||{};
    const style=`${center} translate(${position.x}px, ${position.y}px); width:${size}px; height:auto; position:absolute;`;
    logoTag = `<img src="${appData.logo}" alt="logo" style="${style}">`;
  }

  // Brand logo/text (Position X,Y)
  let brandTag='';
  const brand=(p.brand||'').trim();
  if(brand && tpl.brandLogo?.enabled){
    const { size=28, position={x:0,y:0}, color='#ffffff' } = tpl.brandLogo||{};
    const style=`${center} translate(${position.x}px, ${position.y}px); position:absolute;`;
    const src = appData.brandLogos?.[brand];
    if(src){
      brandTag = `<img src="${src}" alt="${brand}" style="${style} width:${size}px; height:auto;">`;
    }else{
      brandTag = `<div style="${style} font-weight:700; font-size:${size}px; color:${color}; white-space:nowrap;">${brand}</div>`;
    }
  }

  const t=tpl.styles;
  const text = (val, s) => {
    const align = s.align||'left';
    const style = `${center} translate(${s.position?.x||0}px, ${s.position?.y||0}px); position:absolute; font-size:${s.fs||14}px; color:${s.color||'#fff'}; font-weight:${s.fw||'normal'}; font-style:${s.fst||'normal'}; text-decoration:${s.td||'none'}; text-align:${align}; white-space:pre-wrap; max-width:${w-40}px;`;
    return `<div style="${style}">${val||''}</div>`;
  };

  const priceEff=getEffectivePromoPrice(p);
  const content = [
    text(p.sku, t.sku),
    text(p.description, t.description),
    text(p.details, t.details),
    text(money(priceEff), t.price),
    text(p.normalPrice>0 && priceEff<p.normalPrice? money(p.normalPrice):'', t.oldPrice),
    text(formatDisplayDate(p.expiresDate), t.expire)
  ].join('');

  return `<div class="card" style="${styleBox}">
    ${bgImg}${logoTag}${brandTag}${content}
  </div>`;
}

function generatePrintHTML(list, tpl, printable=false){
  const { w,h } = baseSize(tpl.kind);
  const gap=16;
  const cols = Math.max(1, Math.floor((794 - gap) / (w + gap))); // A4 width heuristics
  const css = `
    <style>
      @page { size: A4 portrait; margin: 10mm; }
      body{ background:#fff; color:#000; }
      .sheet{ display:grid; grid-template-columns: repeat(${cols}, ${w}px); gap:${gap}px; }
      .card{ box-shadow: 0 1px 3px rgba(0,0,0,.25); }
      @media print { .no-print{display:none} .sheet{ box-shadow:none } }
    </style>`;
  const cards = (list||[]).map(p=>generateSingleTagHTML(p, tpl)).join('');
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8">${css}</head><body>${printable?'<script>setTimeout(()=>window.print(),300);<\/script>':''}<div class="sheet">${cards}</div></body></html>`;
  return html;
}

/* ================= APP BINDINGS ================= */
function bindAppEvents(){
  $('#btnLogout').onclick=logout;
  $('#btnNewProduct').onclick=()=>openEditor(null);
  $('#btnCloseEditor').onclick=closeEditor;
  $('#btnSaveEd').onclick=saveEditor;

  $('#btnSettings').onclick=()=>openSettings('data');
  $('#btnCloseSettings').onclick=()=>$('#settingsPanel').classList.add('hidden');

  $('#btnPrintModal').onclick=openPrintModal;
  $('#btnClosePrintModal').onclick=closePrintModal;
  $('#btnOpenPrint').onclick=openPrintPage;
  $('#printTemplate').onchange=renderPreview;
  $('#printSearch').oninput=debounce(()=>{ buildPrintList(); renderPreview(); }, 200);
  $('#printCheckAll').onchange=()=>{ const c=$('#printCheckAll').checked; $$('#printList [data-print-sku]').forEach(x=>x.checked=c); renderPreview(); };

  $('#searchInput').oninput=debounce(()=>{ currentPage=1; renderTable(); }, 200);
  $('#channelSelect').onchange=()=>{ currentPage=1; updateColumnVisibility(); renderTable(); };

  // date range
  const picker=new Litepicker({ element:$('#dateRangePicker'), singleMode:false, numberOfMonths:2, numberOfColumns:2, format:'YYYY-MM-DD' });
  picker.on('selected', (d1,d2)=>{ $('#dateStart').value=d1?d1.format('YYYY-MM-DD'):''; $('#dateEnd').value=d2?d2.format('YYYY-MM-DD'):''; currentPage=1; renderTable(); });
  picker.on('clear:selection', ()=>{ $('#dateStart').value=''; $('#dateEnd').value=''; currentPage=1; renderTable(); });
}

/* ================= INITIALIZATION ================= */
async function initialCheck(){
  const token=localStorage.getItem(LS.TOKEN), gist=localStorage.getItem(LS.GIST_ID), last=localStorage.getItem(LS.LAST_USER);
  if(token && gist){
    try{
      await cloudLoad(gist, token);
      const u=(appData.users||[]).find(u=>u.username===last) || (appData.users||[])[0];
      if(u){ performLogin(u); return; }
      $('#loginView').classList.remove('hidden');
    }catch(e){
      console.error(e); showToast('Cloud load failed. Please re-auth.','error');
      $('#cloudSetupView').classList.remove('hidden');
    }
  }else{
    // first time bootstrap default app
    appData = JSON.parse(JSON.stringify(defaultAppState));
    if(!appData.users.length){
      // create host placeholder; user must use Setup
      $('#setupView').classList.remove('hidden');
      return;
    }
    $('#loginView').classList.remove('hidden');
  }
}

function bindAuthEvents(){
  $('#btnCreateHost').onclick=async()=>{
    const pass=$('#setupPass').value, conf=$('#setupPassConfirm').value;
    if(!pass || pass!==conf){ showToast('Passwords do not match.','error'); return; }
    appData = JSON.parse(JSON.stringify(defaultAppState));
    appData.users.push({
      username:'host', passwordHash: await hashPassword(pass), role:'Host',
      channels:['Flagship','Marketplace','Dealer'],
      canPrint:true, permissions:{ canAddItem:true, canManageTemplates:true, canManagePromo:true, canManageMaster:true }
    });
    log('create_host'); $('#setupView').classList.add('hidden'); $('#cloudSetupView').classList.remove('hidden');
  };
  $('#btnCloudCreate').onclick=async()=>{
    try{
      const token=$('#cloudToken').value.trim(); if(!token){ showToast('Token required.','error'); return; }
      const id=await cloudCreateGist(token, appData); showToast('Gist created.','success');
      $('#cloudSetupView').classList.add('hidden'); $('#loginView').classList.remove('hidden');
    }catch(e){ console.error(e); showToast('Create failed.','error'); }
  };
  $('#btnCloudLoad').onclick=async()=>{
    try{
      const token=$('#cloudToken').value.trim(), id=$('#cloudGistId').value.trim(); if(!token||!id){ showToast('Token/Gist required.','error'); return; }
      await cloudLoad(id, token); $('#cloudSetupView').classList.add('hidden'); $('#loginView').classList.remove('hidden'); updateLocalDataAndSave();
    }catch(e){ console.error(e); showToast('Load failed.','error'); }
  };
  $('#btnLogin').onclick=login;
  $('#loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') login(); });
}

/* ================= START ================= */
bindAuthEvents();
initialCheck();

</script>
</body>
</html>
